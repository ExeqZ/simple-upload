<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Upload</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; script-src 'self' https://unpkg.com; img-src 'self' https://images.unsplash.com data:;">
  <meta name="referrer" content="no-referrer" />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Default (Gray) Theme */
      --bg: #f7f7f8;
      --container-bg: #fff;
      --primary: #23272f;
      --accent: #888;
      --border: #d1d5db;
      --button-bg: #23272f;
      --button-text: #fff;
      --dropzone-bg: #f3f4f6;
      --dropzone-border: #bdbdbd;
      --dropzone-accent: #23272f;
      --progress-bg: #e5e7eb;
      --progress-inner: #23272f;
      --success: #388e3c;
      --error: #d32f2f;
    }
    body {
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--primary);
      transition: background 0.2s, color 0.2s;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      max-width: 480px;
      margin: 3rem auto;
      background: var(--container-bg);
      border-radius: 18px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.10);
      padding: 2.5rem 2rem 2rem 2rem;
      transition: background 0.2s;
      position: relative;
      overflow: hidden;
    }
    .header-img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 12px 12px 0 0;
      margin-bottom: 1.2rem;
      filter: brightness(0.93);
      pointer-events: none;
      user-select: none;
    }
    h2 {
      text-align: center;
      margin-bottom: 24px;
      font-weight: 700;
      letter-spacing: -1px;
    }
    .settings-cog {
      position: absolute;
      top: 18px;
      right: 18px;
      width: 28px;
      height: 28px;
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      z-index: 10;
      padding: 0;
      transition: color 0.2s;
    }
    .settings-cog:hover,
    .settings-cog:focus {
      color: #23272f;
    }
    .settings-modal-backdrop {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(40,48,60,0.18);
      z-index: 1000;
      animation: modal-fadein 0.18s;
    }
    @keyframes modal-fadein {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .settings-modal {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.18);
      padding: 28px 32px 22px 32px;
      min-width: 260px;
      z-index: 1001;
      animation: modal-in 0.18s;
      max-width: 90vw;
    }
    @keyframes modal-in {
      from { opacity: 0; transform: translate(-50%,-60%);}
      to { opacity: 1; transform: translate(-50%,-50%);}
    }
    .settings-modal h4 {
      margin: 0 0 18px 0;
      font-size: 1.13rem;
      font-weight: 700;
      color: #23272f;
      letter-spacing: -0.5px;
    }
    .settings-modal .close-btn {
      position: absolute;
      top: 12px;
      right: 18px;
      background: none;
      border: none;
      font-size: 1.3rem;
      color: #888;
      cursor: pointer;
      padding: 0;
      z-index: 2;
      transition: color 0.18s;
    }
    .settings-modal .close-btn:hover {
      color: #23272f;
    }
    .theme-select {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 12px;
      margin-bottom: 0;
    }
    .theme-swatch {
      width: 28px;
      height: 28px;
      border-radius: 7px;
      border: 2px solid var(--border);
      cursor: pointer;
      display: inline-block;
      transition: border 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
      outline: none;
    }
    .theme-swatch.selected {
      border: 3px solid var(--primary);
      box-shadow: 0 0 0 2px var(--accent);
    }
    .theme-swatch[aria-label="Gray"] { background: linear-gradient(135deg, #f7f7f8 60%, #23272f 100%); }
    .theme-swatch[aria-label="Mint"] { background: linear-gradient(135deg, #e0fff7 60%, #3ad29f 100%); }
    .theme-swatch[aria-label="Lavender"] { background: linear-gradient(135deg, #f3e8ff 60%, #7c3aed 100%); }
    .theme-swatch[aria-label="Sand"] { background: linear-gradient(135deg, #fff8e1 60%, #e0b97a 100%); }
    .theme-swatch[aria-label="Contrast"] { background: linear-gradient(135deg, #000 60%, #fff 100%); }
    .theme-swatch[aria-label="Contrast"]::after {
      content: "";
      display: block;
      width: 10px;
      height: 10px;
      background: #ff0;
      border-radius: 2px;
      margin: 8px auto 0 auto;
    }
    /* Mint Theme */
    .theme-mint {
      --bg: #e0fff7;
      --container-bg: #f6fffb;
      --primary: #1b4d3a;
      --accent: #3ad29f;
      --border: #3ad29f;
      --button-bg: #3ad29f;
      --button-text: #fff;
      --dropzone-bg: #e0fff7;
      --dropzone-border: #3ad29f;
      --dropzone-accent: #3ad29f;
      --progress-bg: #eaeaea;
      --progress-inner: #3ad29f;
    }
    /* Lavender Theme */
    .theme-lavender {
      --bg: #f3e8ff;
      --container-bg: #f9f5ff;
      --primary: #4b2067;
      --accent: #7c3aed;
      --border: #7c3aed;
      --button-bg: #7c3aed;
      --button-text: #fff;
      --dropzone-bg: #f3e8ff;
      --dropzone-border: #7c3aed;
      --dropzone-accent: #7c3aed;
      --progress-bg: #eaeaea;
      --progress-inner: #7c3aed;
    }
    /* Sand Theme */
    .theme-sand {
      --bg: #fff8e1;
      --container-bg: #fffbe7;
      --primary: #7c5e3a;
      --accent: #e0b97a;
      --border: #e0b97a;
      --button-bg: #e0b97a;
      --button-text: #7c5e3a;
      --dropzone-bg: #fff8e1;
      --dropzone-border: #e0b97a;
      --dropzone-accent: #e0b97a;
      --progress-bg: #eaeaea;
      --progress-inner: #e0b97a;
    }
    /* High Contrast Theme */
    .theme-contrast {
      --bg: #000;
      --container-bg: #222;
      --primary: #fff;
      --accent: #ff0;
      --border: #fff;
      --button-bg: #ff0;
      --button-text: #000;
      --dropzone-bg: #111;
      --dropzone-border: #fff;
      --dropzone-accent: #ff0;
      --progress-bg: #333;
      --progress-inner: #ff0;
      --success: #0f0;
      --error: #f00;
    }
    .file-list {
      margin-top: 16px;
      padding-left: 20px;
    }
    .progress-bar {
      width: 100%;
      background: var(--progress-bg);
      border-radius: 6px;
      margin-bottom: 12px;
      height: 16px;
      overflow: hidden;
    }
    .progress-bar-inner {
      height: 100%;
      background: var(--progress-inner);
      transition: width 0.2s, background 0.2s;
    }
    .status {
      text-align: center;
      margin-top: 16px;
      font-weight: bold;
    }
    .error {
      color: var(--error);
    }
    .success {
      color: var(--success);
    }
    button {
      width: 100%;
      padding: 0.75rem;
      background: var(--button-bg);
      color: var(--button-text);
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 16px;
      transition: background 0.2s, color 0.2s;
      box-shadow: 0 1px 4px rgba(0,0,0,0.07);
    }
    button:disabled {
      background: #b0b0b0;
      cursor: not-allowed;
    }
    .dropzone {
      border: 2.5px dashed var(--dropzone-border);
      border-radius: 10px;
      padding: 36px 0;
      text-align: center;
      color: var(--dropzone-accent);
      background: var(--dropzone-bg);
      margin-bottom: 16px;
      transition: background 0.2s, border-color 0.2s, color 0.2s;
      font-size: 1.08rem;
      font-weight: 500;
      letter-spacing: 0.01em;
      outline: none;
    }
    .dropzone.dragover {
      background: #e3f1ff;
      border-color: var(--primary);
      color: var(--primary);
    }
    .dropzone input[type="file"] {
      display: none;
    }
    .dropzone-label {
      cursor: pointer;
      font-weight: 600;
      color: var(--dropzone-accent);
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container" id="root"></div>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="/static/app.bundle.js"></script>
</body>
</html>
    // Theme definitions
    const THEMES = [
      { value: '', label: 'Gray', aria: 'Gray' },
      { value: 'theme-mint', label: 'Mint', aria: 'Mint' },
      { value: 'theme-lavender', label: 'Lavender', aria: 'Lavender' },
      { value: 'theme-sand', label: 'Sand', aria: 'Sand' },
      { value: 'theme-contrast', label: 'Contrast', aria: 'Contrast' }
    ];

    function chunkFile(file, chunkSize) {
      const chunks = [];
      let offset = 0;
      while (offset < file.size) {
        const end = Math.min(offset + chunkSize, file.size);
        chunks.push(file.slice(offset, end));
        offset = end;
      }
      return chunks;
    }

    function setThemeClass(theme) {
      document.body.classList.remove(...THEMES.map(t => t.value).filter(Boolean));
      if (theme) document.body.classList.add(theme);
    }

    function getSavedTheme() {
      const match = document.cookie.match(/(^| )simpleupload_theme=([^;]+)/);
      return match ? decodeURIComponent(match[2]) : '';
    }

    function saveTheme(theme) {
      document.cookie = `simpleupload_theme=${encodeURIComponent(theme)};path=/;max-age=31536000`;
    }

    function FileUpload() {
      const [files, setFiles] = useState([]);
      const [progress, setProgress] = useState({});
      const [status, setStatus] = useState('');
      const [isUploading, setIsUploading] = useState(false);
      const [dragActive, setDragActive] = useState(false);
      const [theme, setTheme] = useState(getSavedTheme());
      const [showSettings, setShowSettings] = useState(false);
      const abortControllers = useRef({});
      const fileInputRef = useRef();
      const settingsRef = useRef(); // <-- Add this line

      // Trap focus in modal
      useEffect(() => {
        if (!showSettings) return;
        function trapFocus(e) {
          if (e.key === "Tab") {
            const modal = document.getElementById("settings-modal");
            if (!modal) return;
            const focusable = modal.querySelectorAll('button, [tabindex="0"], [tabindex="1"]');
            if (!focusable.length) return;
            const first = focusable[0];
            const last = focusable[focusable.length - 1];
            if (e.shiftKey) {
              if (document.activeElement === first) {
                last.focus();
                e.preventDefault();
              }
            } else {
              if (document.activeElement === last) {
                first.focus();
                e.preventDefault();
              }
            }
          }
          if (e.key === "Escape") setShowSettings(false);
        }
        document.addEventListener("keydown", trapFocus);
        return () => document.removeEventListener("keydown", trapFocus);
      }, [showSettings]);

      useEffect(() => {
        setThemeClass(theme);
        saveTheme(theme);
      }, [theme]);

      // Close flyout on outside click
      useEffect(() => {
        function handleClick(e) {
          if (showSettings && settingsRef.current && !settingsRef.current.contains(e.target)) {
            setShowSettings(false);
          }
        }
        if (showSettings) {
          document.addEventListener('mousedown', handleClick);
        }
        return () => document.removeEventListener('mousedown', handleClick);
      }, [showSettings]);

      const handleThemeChange = (e) => {
        setTheme(e.target.value);
      };

      const handleFileChange = (e) => {
        setFiles(Array.from(e.target.files));
        setProgress({});
        setStatus('');
      };

      const handleDrop = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setDragActive(false);
        if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
          setFiles(Array.from(e.dataTransfer.files));
          setProgress({});
          setStatus('');
        }
      };

      const handleDragOver = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setDragActive(true);
      };

      const handleDragLeave = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setDragActive(false);
      };

      // Chunked upload for large files (up to multi-TB)
      const uploadFile = async (file, idx) => {
        const CHUNK_SIZE = 100 * 1024 * 1024; // 100MB per chunk
        const chunks = chunkFile(file, CHUNK_SIZE);
        let uploaded = 0;
        let fileProgress = 0;
        let success = true;
        let errorMsg = '';

        for (let i = 0; i < chunks.length; i++) {
          const formData = new FormData();
          formData.append('files', chunks[i], file.name);

          const controller = new AbortController();
          abortControllers.current[file.name] = controller;

          try {
            await new Promise((resolve, reject) => {
              const xhr = new XMLHttpRequest();
              xhr.open('POST', '/api/upload', true);
              xhr.timeout = 10 * 60 * 1000; // 10 minutes per chunk

              xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                  fileProgress = ((uploaded + event.loaded) / file.size) * 100;
                  setProgress(prev => ({ ...prev, [file.name]: Math.min(fileProgress, 100) }));
                }
              };

              xhr.onload = () => {
                if (xhr.status === 200) {
                  uploaded += chunks[i].size;
                  setProgress(prev => ({ ...prev, [file.name]: Math.min((uploaded / file.size) * 100, 100) }));
                  resolve();
                } else {
                  errorMsg = `Upload failed: ${xhr.statusText}`;
                  reject(new Error(errorMsg));
                }
              };

              xhr.ontimeout = () => {
                errorMsg = 'Upload timed out. Retrying...';
                reject(new Error(errorMsg));
              };

              xhr.onerror = () => {
                errorMsg = 'Network error. Retrying...';
                reject(new Error(errorMsg));
              };

              xhr.onabort = () => {
                errorMsg = 'Upload aborted by user.';
                reject(new Error(errorMsg));
              };

              xhr.send(formData);
            });
          } catch (err) {
            // Retry logic: up to 3 times per chunk
            let retries = 2;
            while (retries > 0) {
              try {
                await new Promise((resolve, reject) => {
                  const xhr = new XMLHttpRequest();
                  xhr.open('POST', '/api/upload', true);
                  xhr.timeout = 10 * 60 * 1000;
                  xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable) {
                      fileProgress = ((uploaded + event.loaded) / file.size) * 100;
                      setProgress(prev => ({ ...prev, [file.name]: Math.min(fileProgress, 100) }));
                    }
                  };
                  xhr.onload = () => {
                    if (xhr.status === 200) {
                      uploaded += chunks[i].size;
                      setProgress(prev => ({ ...prev, [file.name]: Math.min((uploaded / file.size) * 100, 100) }));
                      resolve();
                    } else {
                      reject(new Error(`Upload failed: ${xhr.statusText}`));
                    }
                  };
                  xhr.ontimeout = () => reject(new Error('Upload timed out.'));
                  xhr.onerror = () => reject(new Error('Network error.'));
                  xhr.onabort = () => reject(new Error('Upload aborted by user.'));
                  xhr.send(formData);
                });
                errorMsg = '';
                break;
              } catch (retryErr) {
                retries--;
                errorMsg = retryErr.message;
                if (retries === 0) {
                  success = false;
                  break;
                }
              }
            }
            if (!success) break;
          }
        }
        return { success, errorMsg };
      };

      const handleUpload = async () => {
        if (files.length === 0) return;
        setIsUploading(true);
        setStatus('');
        setProgress({});

        let allSuccess = true;
        let errorMessages = [];

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          setProgress(prev => ({ ...prev, [file.name]: 0 }));
          const { success, errorMsg } = await uploadFile(file, i);
          if (!success) {
            allSuccess = false;
            errorMessages.push(`${file.name}: ${errorMsg}`);
          }
        }

        setIsUploading(false);
        if (allSuccess) {
          setStatus('All files uploaded successfully!');
          setFiles([]);
        } else {
          setStatus('Some files failed to upload:\n' + errorMessages.join('\n'));
        }
      };

      const handleAbort = () => {
        Object.values(abortControllers.current).forEach(controller => {
          if (controller && controller.abort) controller.abort();
        });
        setIsUploading(false);
        setStatus('Upload aborted by user.');
      };

      const handleZoneClick = () => {
        if (fileInputRef.current) {
          fileInputRef.current.value = '';
          fileInputRef.current.click();
        }
      };

      return (
        React.createElement(React.Fragment, null,
          // Move header image and cogwheel inside the container
          React.createElement('img', {
            src: 'https://images.unsplash.com/photo-1464983953574-0892a716854b?auto=format&fit=crop&w=800&q=80',
            alt: '',
            className: 'header-img',
            draggable: false,
            'aria-hidden': true,
            loading: 'lazy'
          }),
          React.createElement('button', {
            className: 'settings-cog',
            type: 'button',
            tabIndex: 0,
            onClick: () => setShowSettings(v => !v),
            'aria-label': 'Open settings'
          },
            React.createElement('svg', {
              width: 24, height: 24, fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round', viewBox: '0 0 24 24', 'aria-hidden': true
            },
              React.createElement('circle', { cx: 12, cy: 12, r: 3 }),
              React.createElement('path', { d: 'M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06A1.65 1.65 0 0 0 15 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 8.6 15a1.65 1.65 0 0 0-1.82-.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.6a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 15 8.6c.26.26.61.39.96.33.35-.06.7-.19.96-.33z' })
            )
          ),
          showSettings && React.createElement(React.Fragment, null,
            React.createElement('div', {
              className: 'settings-modal-backdrop',
              onClick: () => setShowSettings(false),
              tabIndex: -1,
              'aria-hidden': true
            }),
            React.createElement('div', {
              className: 'settings-modal',
              id: 'settings-modal',
              tabIndex: -1,
              role: 'dialog',
              'aria-modal': true,
              'aria-label': 'Settings',
              ref: settingsRef
            },
              React.createElement('button', {
                className: 'close-btn',
                type: 'button',
                onClick: () => setShowSettings(false),
                'aria-label': 'Close settings'
              }, '×'),
              React.createElement('h4', null, 'Theme'),
              React.createElement('div', { className: 'theme-select', role: 'radiogroup', 'aria-label': 'Theme selection' },
                THEMES.map(t =>
                  React.createElement('span', {
                    key: t.value,
                    className: 'theme-swatch' + (theme === t.value ? ' selected' : ''),
                    tabIndex: 0,
                    role: 'radio',
                    'aria-checked': theme === t.value,
                    'aria-label': t.aria,
                    style: { outline: theme === t.value ? '2px solid var(--accent)' : 'none' },
                    onClick: () => setTheme(t.value),
                    onKeyDown: (e) => { if (e.key === 'Enter' || e.key === ' ') setTheme(t.value); }
                  })
                )
              )
            )
          ),
          React.createElement('div', {
            className: 'dropzone' + (dragActive ? ' dragover' : ''),
            onClick: handleZoneClick,
            onDragOver: handleDragOver,
            onDragLeave: handleDragLeave,
            onDragEnd: handleDragLeave,
            onDrop: handleDrop,
            tabIndex: 0,
            role: 'button',
            'aria-label': 'Drag and drop files here or click to select files'
          },
            React.createElement('input', {
              type: 'file',
              multiple: true,
              ref: fileInputRef,
              onChange: handleFileChange,
              tabIndex: -1,
              style: { display: 'none' }
            }),
            React.createElement('span', { className: 'dropzone-label' }, 'Drag & drop files here or click to select')
          ),
          React.createElement('button', {
            onClick: handleUpload,
            disabled: isUploading || files.length === 0
          }, isUploading ? 'Uploading...' : 'Upload Files'),
          isUploading && React.createElement('button', {
            onClick: handleAbort,
            style: { background: '#d32f2f', marginBottom: 0 }
          }, 'Abort Upload'),
          files.length > 0 && React.createElement('ul', { className: 'file-list' },
            files.map(file =>
              React.createElement('li', { key: file.name },
                file.name,
                React.createElement('div', { className: 'progress-bar' },
                  React.createElement('div', {
                    className: 'progress-bar-inner',
                    style: { width: `${progress[file.name] || 0}%` }
                  })
                ),
                React.createElement('span', null, `${(progress[file.name] || 0).toFixed(1)}%`)
              )
            )
          ),
          status && React.createElement('div', {
            className: 'status ' + (status.includes('success') ? 'success' : 'error'),
            role: 'alert'
          }, status)
        )
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(FileUpload));
  </script>
</body>
</html>
